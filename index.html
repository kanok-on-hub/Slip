<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Payment & Claim Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --primary: #111827;
      --accent: #10b981;
      --danger: #ef4444;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #e5f2ff, #f9fafb 45%, #f3f4f6);
      color: var(--text-main);
    }

    .page {
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .shell {
      width: 100%;
      max-width: 520px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      box-shadow:
        0 20px 40px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      padding: 18px 16px 16px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #fefce8, #fee2e2);
      font-size: 22px;
    }

    .header-text-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .header-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .mode-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      font-size: 11px;
      color: #4f46e5;
      font-weight: 600;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .badge-soft {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0f766e;
      border: 1px solid #ccfbf1;
    }

    .fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-main);
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field-value {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-main);
      word-break: break-all;
    }

    .field-value a {
      color: #2563eb;
      text-decoration: none;
      font-size: 12px;
    }

    .field-value a:hover {
      text-decoration: underline;
    }

    .input {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 7px 10px;
      font-size: 13px;
      outline: none;
      width: 100%;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.12);
      background: #ffffff;
    }

    .input[readonly] {
      background: #f3f4f6;
      color: #6b7280;
    }

    textarea.input {
      min-height: 72px;
      resize: vertical;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: var(--text-muted);
    }

    .pill strong {
      color: var(--text-main);
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.06s ease, box-shadow 0.06s ease,
        background 0.12s ease;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.25);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.3);
    }

    .btn-outline {
      background: #f9fafb;
      color: var(--text-main);
      border: 1px solid #e5e7eb;
      box-shadow: 0 3px 8px rgba(148, 163, 184, 0.3);
    }

    .btn-outline:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(148, 163, 184, 0.4);
    }

    .btn-icon {
      font-size: 16px;
    }

    .footer-note {
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 2px;
    }

    .status-bar {
      margin-top: 2px;
      font-size: 11px;
      padding: 7px 9px;
      border-radius: 10px;
      background: #eff6ff;
      color: #1d4ed8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .status-bar.error {
      background: #fef2f2;
      color: #b91c1c;
    }

    .status-dot.error {
      background: #ef4444;
    }

    .tag-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 480px) {
      .shell {
        border-radius: 18px;
        box-shadow:
          0 12px 26px rgba(15, 23, 42, 0.18),
          0 0 0 1px rgba(148, 163, 184, 0.1);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <!-- Header -->
      <div class="header">
        <div class="header-icon" id="headerIcon">
          üí∏
        </div>
        <div>
          <div class="header-text-main" id="headerTitle">Payment Editor</div>
          <div class="header-text-sub" id="headerSubtitle">
            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
          </div>
        </div>
      </div>

      <!-- Mode pill -->
      <div class="mode-pill" id="modePill">
        <span id="modeEmoji">üí≥</span>
        <span id="modeText">Payment Collection</span>
      </div>

      <!-- Status bar -->
      <div class="status-bar" id="statusBar">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</span>
      </div>

      <!-- PAYMENT SECTION -->
      <div id="paymentSection" class="card hidden">
        <div class="card-title-row">
          <div class="card-title">PAYMENT SUMMARY</div>
          <div id="paymentRunNoBadge" class="badge-soft">Run No. ‚Äî</div>
        </div>

        <div class="fields">
          <!-- File Info -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Slip File</span>
            </div>
            <div class="field-value" id="paymentFileInfo">
              ‚Äî
            </div>
          </div>

          <!-- Receiver / Company -->
          <div class="field" id="paymentFieldCompany">
            <div class="field-label-row">
              <span class="field-label">Company (Receiver)</span>
              <span class="field-hint">AVT / ACC / BDI</span>
            </div>
            <input
              id="paymentCompany"
              class="input"
              type="text"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô AVT"
            />
          </div>

          <!-- Customer -->
          <div class="field" id="paymentFieldCustomer">
            <div class="field-label-row">
              <span class="field-label">Customer Name</span>
              <span class="field-hint">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </div>
            <input
              id="paymentCustomer"
              class="input"
              type="text"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ADecor"
            />
          </div>

          <!-- Date -->
          <div class="field" id="paymentFieldDate">
            <div class="field-label-row">
              <span class="field-label">Transaction Date</span>
              <span class="field-hint">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 24/2/2026</span>
            </div>
            <input
              id="paymentDate"
              class="input"
              type="text"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 24/2/2026"
            />
          </div>

          <!-- Amount -->
          <div class="field" id="paymentFieldAmount">
            <div class="field-label-row">
              <span class="field-label">Amount (THB)</span>
            </div>
            <input
              id="paymentAmount"
              class="input"
              type="number"
              inputmode="decimal"
              step="0.01"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 5999"
            />
          </div>

          <!-- Advance Note -->
          <div class="field hidden" id="paymentFieldNote">
            <div class="field-label-row">
              <span class="field-label">Advance Note</span>
              <span class="field-hint">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô / ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á</span>
            </div>
            <textarea
              id="paymentNote"
              class="input"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
            ></textarea>
          </div>
        </div>

        <div class="pill-row">
          <span class="pill"><strong>Run No.</strong> <span id="paymentRunNoPill">‚Äî</span></span>
          <span class="pill"><strong>Mode</strong> <span id="paymentModePill">Normal</span></span>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnSavePayment">
            <span class="btn-icon">üíæ</span>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
          <button class="btn btn-outline" id="btnResetPayment">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</span>
          </button>
        </div>
      </div>

      <!-- CLAIM SECTION -->
      <div id="claimSection" class="card hidden">
        <div class="card-title-row">
          <div class="card-title">CLAIM REQUEST SUMMARY</div>
          <div id="claimRunNoBadge" class="badge-soft">Run No. ‚Äî</div>
        </div>

        <div class="fields">
          <!-- File Info -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Claim Form (PDF)</span>
            </div>
            <div class="field-value" id="claimFileInfo">
              ‚Äî
            </div>
          </div>

          <!-- Company -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Company</span>
              <span class="field-hint">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
            </div>
            <input
              id="claimCompany"
              class="input"
              type="text"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô AVT / ACC / BDI"
            />
          </div>

          <!-- Period -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Claim Period</span>
              <span class="field-hint">‡πÄ‡∏ä‡πà‡∏ô 02/2026</span>
            </div>
            <input
              id="claimPeriod"
              class="input"
              type="text"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 02/2026"
            />
          </div>

          <!-- Amount -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Amount (THB)</span>
            </div>
            <input
              id="claimAmount"
              class="input"
              type="number"
              inputmode="decimal"
              step="0.01"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 1250"
            />
          </div>

          <!-- Status (readonly display) -->
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Status</span>
            </div>
            <div class="field-value">
              <span id="claimStatusText">DRAFT</span>
              <span id="claimStatusTag" class="tag-status hidden">SUBMITTED</span>
            </div>
          </div>
        </div>

        <div class="pill-row">
          <span class="pill"><strong>Run No.</strong> <span id="claimRunNoPill">‚Äî</span></span>
          <span class="pill"><strong>Mode</strong> Claim Request</span>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnSaveClaim">
            <span class="btn-icon">üíæ</span>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
          <button class="btn btn-outline" id="btnResetClaim">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</span>
          </button>
        </div>

        <div class="footer-note">
          ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô SUBMITTED ‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô LINE Chat
        </div>
      </div>

      <div class="footer-note">
        ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>
    </div>
  </div>

  <script>
    // üîß TODO: ‡πÅ‡∏Å‡πâ URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Web App ‡∏Ç‡∏≠‡∏á Script Backend
    const PAYMENT_API_URL = 'https://script.google.com/macros/s/AKfycbysUQ6VItRGSDHON-5SDIJe1qQA1dsD7q5ng7K-_RxPNCBBeermnsCk2MUQfrSk7Sff/exec';
    const CLAIM_API_URL   = 'https://script.google.com/macros/s/AKfycbzfKuGhUIOPpsCutKSm8fPdQ6kObnKE2jZJmW34ur-NPw9YgavbZmB3II5oJnvSUouuEQ/exec';

    const state = {
      mode: 'payment', // 'payment' | 'claim'
      runNo: '',
      receiver: '',
      rawPaymentData: null,
      rawClaimData: null
    };

    function getQueryParams() {
      const params = {};
      const usp = new URLSearchParams(window.location.search || '');
      usp.forEach((v, k) => {
        params[k] = v;
      });
      return params;
    }

    function setStatus(message, isError = false) {
      const bar = document.getElementById('statusBar');
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      text.textContent = message || '';
      if (isError) {
        bar.classList.add('error');
        dot.classList.add('error');
      } else {
        bar.classList.remove('error');
        dot.classList.remove('error');
      }
    }

    function setMode(mode) {
      state.mode = mode === 'claim' ? 'claim' : 'payment';
      const headerIcon = document.getElementById('headerIcon');
      const headerTitle = document.getElementById('headerTitle');
      const headerSubtitle = document.getElementById('headerSubtitle');
      const modePill = document.getElementById('modePill');
      const modeEmoji = document.getElementById('modeEmoji');
      const modeText = document.getElementById('modeText');
      const paymentSection = document.getElementById('paymentSection');
      const claimSection = document.getElementById('claimSection');

      if (state.mode === 'payment') {
        headerIcon.textContent = 'üí∏';
        headerTitle.textContent = 'Payment Editor';
        headerSubtitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö';
        modeEmoji.textContent = 'üí≥';
        modeText.textContent = 'Payment Collection';
        paymentSection.classList.remove('hidden');
        claimSection.classList.add('hidden');
      } else {
        headerIcon.textContent = 'üìÑ';
        headerTitle.textContent = 'Claim Editor';
        headerSubtitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å (PDF) ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
        modeEmoji.textContent = 'üìë';
        modeText.textContent = 'Claim Request';
        paymentSection.classList.add('hidden');
        claimSection.classList.remove('hidden');
      }
    }

    /** ================= PAYMENT BINDING ================= */

    function bindPaymentForm(data) {
      state.rawPaymentData = JSON.parse(JSON.stringify(data || {}));

      const fileInfoEl = document.getElementById('paymentFileInfo');
      const runNoBadge = document.getElementById('paymentRunNoBadge');
      const runNoPill = document.getElementById('paymentRunNoPill');
      const modePill = document.getElementById('paymentModePill');

      const companyInput = document.getElementById('paymentCompany');
      const customerInput = document.getElementById('paymentCustomer');
      const dateInput = document.getElementById('paymentDate');
      const amountInput = document.getElementById('paymentAmount');
      const noteInput = document.getElementById('paymentNote');

      const fieldCompany = document.getElementById('paymentFieldCompany');
      const fieldCustomer = document.getElementById('paymentFieldCustomer');
      const fieldDate = document.getElementById('paymentFieldDate');
      const fieldAmount = document.getElementById('paymentFieldAmount');
      const fieldNote = document.getElementById('paymentFieldNote');

      const runNo = data.runNo || state.runNo || '-';
      const fileName = data.fileName || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)';
      const fileUrl = data.fileUrl || '';

      runNoBadge.textContent = 'Run No. ' + runNo;
      runNoPill.textContent = runNo;

      if (fileUrl) {
        fileInfoEl.innerHTML = `
          <span>${fileName}</span>
          <a href="${fileUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>
        `;
      } else {
        fileInfoEl.textContent = fileName;
      }

      const mode = data.mode || (data.receiverName === 'ADVANCE' || data.receiver === 'ADVANCE' ? 'ADVANCE' : 'NORMAL');

      if (mode === 'ADVANCE') {
        modePill.textContent = 'Advance';
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏™‡∏î‡∏á Note ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        fieldCompany.classList.add('hidden');
        fieldCustomer.classList.add('hidden');
        fieldDate.classList.add('hidden');
        fieldAmount.classList.add('hidden');
        fieldNote.classList.remove('hidden');

        companyInput.value = data.receiverName || data.receiver || 'ADVANCE';
        customerInput.value = data.senderName || '';
        dateInput.value = data.transactionDateText || '';
        amountInput.value = data.amount || '';
        noteInput.value = data.note || data.noteText || '';
      } else {
        modePill.textContent = 'Normal';
        fieldCompany.classList.remove('hidden');
        fieldCustomer.classList.remove('hidden');
        fieldDate.classList.remove('hidden');
        fieldAmount.classList.remove('hidden');
        fieldNote.classList.add('hidden');

        companyInput.value = data.receiverName || data.receiver || '';
        customerInput.value = data.senderName || '';
        dateInput.value = data.transactionDateText || '';
        amountInput.value = data.amount || data.amountText || '';
        noteInput.value = '';
      }
    }

    function resetPaymentForm() {
      if (!state.rawPaymentData) return;
      bindPaymentForm(state.rawPaymentData);
      setStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß', false);
    }

    async function savePayment() {
      if (!state.runNo || !state.receiver) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö runNo ‡∏´‡∏£‡∏∑‡∏≠ receiver ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      const company = document.getElementById('paymentCompany').value.trim();
      const customer = document.getElementById('paymentCustomer').value.trim();
      const dateText = document.getElementById('paymentDate').value.trim();
      const amount = document.getElementById('paymentAmount').value.trim();
      const note = document.getElementById('paymentNote').value.trim();
      const modeText = document.getElementById('paymentModePill').textContent || 'Normal';

      const isAdvance = (modeText || '').toUpperCase() === 'ADVANCE';

      if (!isAdvance) {
        if (!company) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Company (Receiver) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
          return;
        }
        if (!customer) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Customer Name ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
          return;
        }
        if (!dateText) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Transaction Date ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
          return;
        }
        if (!amount) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Amount ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
          return;
        }
      } else {
        if (!note) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Note ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advance ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
          return;
        }
      }

      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment...', false);

      try {
        const payload = {
          action: isAdvance ? 'updateAdvance' : 'updatePayment',
          runNo: state.runNo,
          receiver: state.receiver,
          company,
          customer,
          transactionDate: dateText,
          amount,
          note
        };

        const res = await fetch(PAYMENT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }

        const json = await res.json();
        if (!json.success) {
          throw new Error(json.message || 'Update failed');
        }

        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Payment ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úî', false);
        if (json.data) {
          bindPaymentForm(json.data);
        }
      } catch (err) {
        console.error('savePayment error', err);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || 'Unknown error'), true);
      }
    }

    /** ================= CLAIM BINDING ================= */

    function bindClaimForm(data) {
      state.rawClaimData = JSON.parse(JSON.stringify(data || {}));

      const fileInfoEl = document.getElementById('claimFileInfo');
      const runNoBadge = document.getElementById('claimRunNoBadge');
      const runNoPill = document.getElementById('claimRunNoPill');

      const companyInput = document.getElementById('claimCompany');
      const periodInput = document.getElementById('claimPeriod');
      const amountInput = document.getElementById('claimAmount');
      const statusText = document.getElementById('claimStatusText');
      const statusTag = document.getElementById('claimStatusTag');

      const runNo = data.runNo || state.runNo || '-';
      const fileName = data.fileName || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)';
      const fileUrl = data.fileUrl || '';
      const status = (data.status || 'DRAFT').toUpperCase();

      runNoBadge.textContent = 'Run No. ' + runNo;
      runNoPill.textContent = runNo;

      if (fileUrl) {
        fileInfoEl.innerHTML = `
          <span>${fileName}</span>
          <a href="${fileUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>
        `;
      } else {
        fileInfoEl.textContent = fileName;
      }

      companyInput.value = data.company || '';
      periodInput.value = data.period || '';
      amountInput.value = data.amount || '';

      statusText.textContent = status;
      if (status === 'SUBMITTED') {
        statusTag.classList.remove('hidden');
      } else {
        statusTag.classList.add('hidden');
      }
    }

    function resetClaimForm() {
      if (!state.rawClaimData) return;
      bindClaimForm(state.rawClaimData);
      setStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß', false);
    }

    async function saveClaim() {
      if (!state.runNo) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö runNo ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      const company = document.getElementById('claimCompany').value.trim();
      const period = document.getElementById('claimPeriod').value.trim();
      const amount = document.getElementById('claimAmount').value.trim();

      if (!company) {
        setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Company ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
        return;
      }
      if (!period) {
        setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Claim Period ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
        return;
      }
      if (!amount) {
        setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Amount ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
        return;
      }

      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim...', false);

      try {
        const payload = {
          action: 'updateClaim',
          runNo: state.runNo,
          company,
          period,
          amount
        };

        const res = await fetch(CLAIM_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }

        const json = await res.json();
        if (!json.success) {
          throw new Error(json.message || 'Update failed');
        }

        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Claim ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úî', false);
        if (json.data) {
          bindClaimForm(json.data);
        }
      } catch (err) {
        console.error('saveClaim error', err);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || 'Unknown error'), true);
      }
    }

    /** ================= INIT ================= */

    async function init() {
      const params = getQueryParams();
      state.runNo = params.runNo || '';
      state.receiver = params.receiver || '';

      // mode priority:
      // 1) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ mode=claim ‚Üí claim
      // 2) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ mode=payment ‚Üí payment
      // 3) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ receiver ‡πÄ‡∏•‡∏¢ ‚Üí claim
      // 4) default ‚Üí payment
      const modeParam = (params.mode || params.bot || '').toLowerCase();
      let mode = 'payment';
      if (modeParam === 'claim') mode = 'claim';
      else if (modeParam === 'payment') mode = 'payment';
      else if (!state.receiver) mode = 'claim';

      setMode(mode);

      // bind listeners
      document
        .getElementById('btnSavePayment')
        .addEventListener('click', savePayment);
      document
        .getElementById('btnResetPayment')
        .addEventListener('click', resetPaymentForm);
      document
        .getElementById('btnSaveClaim')
        .addEventListener('click', saveClaim);
      document
        .getElementById('btnResetClaim')
        .addEventListener('click', resetClaimForm);

      if (!state.runNo) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Run No. ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      try {
        if (state.mode === 'payment') {
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment...', false);
          const url =
            PAYMENT_API_URL +
            '?action=getPayment&runNo=' +
            encodeURIComponent(state.runNo) +
            '&receiver=' +
            encodeURIComponent(state.receiver || '');
          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          if (!json.success || !json.data) {
            throw new Error(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment');
          }
          bindPaymentForm(json.data);
          setStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', false);
        } else {
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim...', false);
          const url =
            CLAIM_API_URL +
            '?action=getClaim&runNo=' +
            encodeURIComponent(state.runNo);
          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          if (!json.success || !json.data) {
            throw new Error(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim');
          }
          bindClaimForm(json.data);
          setStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', false);
        }
      } catch (err) {
        console.error('init load error', err);
        setStatus(
          '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' +
            (err.message || 'Unknown error') +
            ' (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)',
          true
        );
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
