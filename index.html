<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Payment & Claim Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* ‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ó‡∏ô ‡∏î‡∏≥-‡πÄ‡∏ó‡∏≤-‡∏Ç‡∏≤‡∏ß */
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --primary: #111827;       /* ‡∏î‡∏≥‡∏™‡∏ô‡∏¥‡∏ó */
      --secondary: #4b5563;     /* ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
      --border: #e5e7eb;        /* ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 16px;
    }

    .page {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .shell {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border: 1px solid var(--border);
    }

    /* --- Header --- */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      border: 1px solid var(--border);
      font-size: 22px;
    }

    .header-text-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .header-text-sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* --- Pills & Tags --- */
    .mode-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--primary);
      font-weight: 600;
      align-self: flex-start;
    }

    /* --- Status Bar --- */
    .status-bar {
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      background: #f3f4f6;
      color: var(--secondary);
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #9ca3af;
    }

    /* Success State */
    .status-bar.success {
      background: #f0fdf4;
      color: #166534;
      border-color: #dcfce7;
    }
    .status-dot.success {
      background: #22c55e;
    }

    /* Error State */
    .status-bar.error {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fee2e2;
    }
    .status-dot.error {
      background: #ef4444;
    }

    /* --- Cards & Fields --- */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 10px;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    .badge-soft {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      color: var(--primary);
      border: 1px solid var(--border);
      font-weight: 600;
    }

    .fields {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .field-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field-value {
      font-size: 14px;
      color: var(--text-main);
      background: #f9fafb;
      padding: 10px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      word-break: break-all;
    }

    .field-value a {
      color: var(--primary);
      text-decoration: underline;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      margin-left: 10px;
    }

    /* --- Inputs --- */
    .input {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      width: 100%;
      background: #ffffff;
      color: var(--text-main);
      transition: all 0.2s ease;
    }

    .input::placeholder {
      color: #9ca3af;
    }

    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
    }

    .input[readonly] {
      background: #f3f4f6;
      color: #6b7280;
    }

    textarea.input {
      min-height: 80px;
      resize: vertical;
    }

    /* --- Info Pills --- */
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      background: #f3f4f6;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .pill strong {
      color: var(--text-main);
    }

    /* --- Buttons --- */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: var(--radius-md);
      border: none;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 4px 6px rgba(17, 24, 39, 0.1);
    }

    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(17, 24, 39, 0.1);
    }

    .btn-outline {
      background: #ffffff;
      color: var(--text-main);
      border: 1px solid var(--border);
    }

    .btn-outline:active {
      background: #f9fafb;
      transform: scale(0.98);
    }

    .btn-icon {
      font-size: 16px;
    }

    /* --- Footer --- */
    .footer-note {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      margin-top: 10px;
      padding: 0 10px;
    }

    .tag-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      background: var(--primary);
      color: #ffffff;
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="shell">
      <div class="header">
        <div class="header-icon" id="headerIcon">
          üí∏
        </div>
        <div>
          <div class="header-text-main" id="headerTitle">Payment Editor</div>
          <div class="header-text-sub" id="headerSubtitle">
            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
          </div>
        </div>
      </div>

      <div class="mode-pill" id="modePill">
        <span id="modeEmoji">üí≥</span>
        <span id="modeText">Payment Collection</span>
      </div>

      <div class="status-bar" id="statusBar">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</span>
      </div>

      <!-- PAYMENT / ADVANCE -->
      <div id="paymentSection" class="card hidden">
        <div class="card-title-row">
          <div class="card-title">PAYMENT SUMMARY</div>
          <div id="paymentRunNoBadge" class="badge-soft">Run No. ‚Äî</div>
        </div>

        <div class="fields">
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Slip File</span>
            </div>
            <div class="field-value" id="paymentFileInfo">
              ‚Äî
            </div>
          </div>

          <div class="field" id="paymentFieldCompany">
            <div class="field-label-row">
              <span class="field-label">Company (Receiver)</span>
              <span class="field-hint">AVT / ACC / BDI</span>
            </div>
            <input id="paymentCompany" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô AVT" />
          </div>

          <div class="field" id="paymentFieldCustomer">
            <div class="field-label-row">
              <span class="field-label">Customer Name</span>
              <span class="field-hint">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </div>
            <input id="paymentCustomer" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ADecor" />
          </div>

          <div class="field" id="paymentFieldDate">
            <div class="field-label-row">
              <span class="field-label">Transaction Date</span>
              <span class="field-hint">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 24/2/2026</span>
            </div>
            <input id="paymentDate" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 24/2/2026" />
          </div>

          <div class="field" id="paymentFieldAmount">
            <div class="field-label-row">
              <span class="field-label">Amount (THB)</span>
            </div>
            <input id="paymentAmount" class="input" type="number" inputmode="decimal" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5999" />
          </div>

          <div class="field hidden" id="paymentFieldNote">
            <div class="field-label-row">
              <span class="field-label">Advance Note</span>
              <span class="field-hint">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô / ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á</span>
            </div>
            <textarea id="paymentNote" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
          </div>
        </div>

        <div class="pill-row">
          <span class="pill"><strong>Run No.</strong> <span id="paymentRunNoPill">‚Äî</span></span>
          <span class="pill"><strong>Mode</strong> <span id="paymentModePill">Normal</span></span>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnSavePayment">
            <span class="btn-icon">üíæ</span>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
          <button class="btn btn-outline" id="btnResetPayment">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</span>
          </button>
        </div>
      </div>

      <!-- CLAIM -->
      <div id="claimSection" class="card hidden">
        <div class="card-title-row">
          <div class="card-title">CLAIM REQUEST SUMMARY</div>
          <div id="claimRunNoBadge" class="badge-soft">Run No. ‚Äî</div>
        </div>

        <div class="fields">
          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Claim Form (PDF)</span>
            </div>
            <div class="field-value" id="claimFileInfo">
              ‚Äî
            </div>
          </div>

          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Company</span>
              <span class="field-hint">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
            </div>
            <input id="claimCompany" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô AVT / ACC / BDI" />
          </div>

          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Claim Period</span>
              <span class="field-hint">‡πÄ‡∏ä‡πà‡∏ô 02/2026</span>
            </div>
            <input id="claimPeriod" class="input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 02/2026" />
          </div>

          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Amount (THB)</span>
            </div>
            <input id="claimAmount" class="input" type="number" inputmode="decimal" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1250" />
          </div>

          <div class="field">
            <div class="field-label-row">
              <span class="field-label">Status</span>
            </div>
            <div class="field-value" style="background: #ffffff; border: 1px solid var(--border);">
              <span id="claimStatusText" style="font-weight: 600;">DRAFT</span>
              <span id="claimStatusTag" class="tag-status hidden">SUBMITTED</span>
            </div>
          </div>
        </div>

        <div class="pill-row">
          <span class="pill"><strong>Run No.</strong> <span id="claimRunNoPill">‚Äî</span></span>
          <span class="pill"><strong>Mode</strong> Claim Request</span>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnSaveClaim">
            <span class="btn-icon">üíæ</span>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
          </button>
          <button class="btn btn-outline" id="btnResetClaim">
            <span class="btn-icon">‚Ü©Ô∏è</span>
            <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</span>
          </button>
        </div>

        <div class="footer-note" style="margin-top: 0;">
          * ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô SUBMITTED ‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô LINE Chat
        </div>
      </div>

      <div class="footer-note">
        ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>
    </div>
  </div>

  <script>
    // üîß TODO: ‡πÅ‡∏Å‡πâ URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Web App ‡∏Ç‡∏≠‡∏á Script Backend
    const PAYMENT_API_URL = 'https://script.google.com/macros/s/AKfycbysUQ6VItRGSDHON-5SDIJe1qQA1dsD7q5ng7K-_RxPNCBBeermnsCk2MUQfrSk7Sff/exec';
    const CLAIM_API_URL   = 'https://script.google.com/macros/s/AKfycbzfKuGhUIOPpsCutKSm8fPdQ6kObnKE2jZJmW34ur-NPw9YgavbZmB3II5oJnvSUouuEQ/exec';

    const state = {
      mode: 'payment', // 'payment' | 'claim'
      runNo: '',
      receiver: '',
      rawPaymentData: null,
      rawClaimData: null
    };

    function getQueryParams() {
      const params = {};
      const usp = new URLSearchParams(window.location.search || '');
      usp.forEach((v, k) => {
        params[k] = v;
      });
      return params;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Status Bar (‡πÄ‡∏ó‡∏≤ = ‡∏õ‡∏Å‡∏ï‡∏¥, ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ‡πÅ‡∏î‡∏á = ‡πÄ‡∏≠‡∏≠‡πÄ‡∏£‡πà‡∏≠)
    function setStatus(message, isError = false) {
      const bar = document.getElementById('statusBar');
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      text.textContent = message || '';
      
      bar.className = 'status-bar';
      dot.className = 'status-dot';

      if (isError) {
        bar.classList.add('error');
        dot.classList.add('error');
      } else if (message.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢') || message.includes('‚úî')) {
        bar.classList.add('success');
        dot.classList.add('success');
      }
    }

    function setMode(mode) {
      state.mode = mode === 'claim' ? 'claim' : 'payment';
      const headerIcon = document.getElementById('headerIcon');
      const headerTitle = document.getElementById('headerTitle');
      const headerSubtitle = document.getElementById('headerSubtitle');
      const modeEmoji = document.getElementById('modeEmoji');
      const modeText = document.getElementById('modeText');
      const paymentSection = document.getElementById('paymentSection');
      const claimSection = document.getElementById('claimSection');

      if (state.mode === 'payment') {
        headerIcon.textContent = 'üí∏';
        headerTitle.textContent = 'Payment Editor';
        headerSubtitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö';
        modeEmoji.textContent = 'üí≥';
        modeText.textContent = 'Payment Collection';
        paymentSection.classList.remove('hidden');
        claimSection.classList.add('hidden');
      } else {
        headerIcon.textContent = 'üìÑ';
        headerTitle.textContent = 'Claim Editor';
        headerSubtitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
        modeEmoji.textContent = 'üìë';
        modeText.textContent = 'Claim Request';
        paymentSection.classList.add('hidden');
        claimSection.classList.remove('hidden');
      }
    }

    /** ================= PAYMENT BINDING ================= */

    function bindPaymentForm(data) {
      state.rawPaymentData = JSON.parse(JSON.stringify(data || {}));

      const fileInfoEl = document.getElementById('paymentFileInfo');
      const runNoBadge = document.getElementById('paymentRunNoBadge');
      const runNoPill = document.getElementById('paymentRunNoPill');
      const modePill = document.getElementById('paymentModePill');

      const companyInput = document.getElementById('paymentCompany');
      const customerInput = document.getElementById('paymentCustomer');
      const dateInput = document.getElementById('paymentDate');
      const amountInput = document.getElementById('paymentAmount');
      const noteInput = document.getElementById('paymentNote');

      const fieldCompany = document.getElementById('paymentFieldCompany');
      const fieldCustomer = document.getElementById('paymentFieldCustomer');
      const fieldDate = document.getElementById('paymentFieldDate');
      const fieldAmount = document.getElementById('paymentFieldAmount');
      const fieldNote = document.getElementById('paymentFieldNote');

      const runNo = data.runNo || state.runNo || '-';
      const fileName = data.fileName || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)';
      const fileUrl = data.fileUrl || '';

      runNoBadge.textContent = 'Run No. ' + runNo;
      runNoPill.textContent = runNo;

      if (fileUrl) {
        fileInfoEl.innerHTML = `
          <span>${fileName}</span>
          <a href="${fileUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>
        `;
      } else {
        fileInfoEl.textContent = fileName;
      }

      const mode = data.mode || (data.receiverName === 'ADVANCE' || data.receiver === 'ADVANCE' ? 'ADVANCE' : 'NORMAL');

      if (mode === 'ADVANCE') {
        modePill.textContent = 'Advance';
        fieldCompany.classList.add('hidden');
        fieldCustomer.classList.add('hidden');
        fieldDate.classList.add('hidden');
        fieldAmount.classList.add('hidden');
        fieldNote.classList.remove('hidden');

        companyInput.value = data.receiverName || data.receiver || 'ADVANCE';
        customerInput.value = data.senderName || '';
        dateInput.value = data.transactionDateText || '';
        amountInput.value = data.amount || '';
        noteInput.value = data.note || data.noteText || '';
      } else {
        modePill.textContent = 'Normal';
        fieldCompany.classList.remove('hidden');
        fieldCustomer.classList.remove('hidden');
        fieldDate.classList.remove('hidden');
        fieldAmount.classList.remove('hidden');
        fieldNote.classList.add('hidden');

        companyInput.value = data.receiverName || data.receiver || '';
        customerInput.value = data.senderName || '';
        dateInput.value = data.transactionDateText || '';
        amountInput.value = data.amount || data.amountText || '';
        noteInput.value = '';
      }
    }

    function resetPaymentForm() {
      if (!state.rawPaymentData) return;
      bindPaymentForm(state.rawPaymentData);
      setStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß', false);
    }

    async function savePayment() {
      if (!state.runNo || !state.receiver) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö runNo ‡∏´‡∏£‡∏∑‡∏≠ receiver ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      const company = document.getElementById('paymentCompany').value.trim();
      const customer = document.getElementById('paymentCustomer').value.trim();
      const dateText = document.getElementById('paymentDate').value.trim();
      const amount = document.getElementById('paymentAmount').value.trim();
      const note = document.getElementById('paymentNote').value.trim();
      const modeText = document.getElementById('paymentModePill').textContent || 'Normal';

      const isAdvance = (modeText || '').toUpperCase() === 'ADVANCE';

      if (!isAdvance) {
        if (!company) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Company (Receiver) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
        if (!customer) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Customer Name ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
        if (!dateText) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Transaction Date ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
        if (!amount) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Amount ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
      } else {
        if (!note) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Note ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advance ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
      }

      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment...', false);

      try {
        const payload = {
          action: isAdvance ? 'updateAdvance' : 'updatePayment',
          runNo: state.runNo,
          receiver: state.receiver,
          company,
          customer,
          transactionDate: dateText,
          amount,
          note
        };

        const res = await fetch(PAYMENT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        if (!json.success) throw new Error(json.message || 'Update failed');

        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Payment ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úî', false);
        if (json.data) bindPaymentForm(json.data);
      } catch (err) {
        console.error('savePayment error', err);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || 'Unknown error'), true);
      }
    }

    /** ================= CLAIM BINDING ================= */

    function bindClaimForm(data) {
      state.rawClaimData = JSON.parse(JSON.stringify(data || {}));

      const fileInfoEl = document.getElementById('claimFileInfo');
      const runNoBadge = document.getElementById('claimRunNoBadge');
      const runNoPill = document.getElementById('claimRunNoPill');

      const companyInput = document.getElementById('claimCompany');
      const periodInput = document.getElementById('claimPeriod');
      const amountInput = document.getElementById('claimAmount');
      const statusText = document.getElementById('claimStatusText');
      const statusTag = document.getElementById('claimStatusTag');

      const runNo = data.runNo || state.runNo || '-';
      const fileName = data.fileName || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)';
      const fileUrl = data.fileUrl || '';
      const status = (data.status || 'DRAFT').toUpperCase();

      runNoBadge.textContent = 'Run No. ' + runNo;
      runNoPill.textContent = runNo;

      if (fileUrl) {
        fileInfoEl.innerHTML = `
          <span>${fileName}</span>
          <a href="${fileUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>
        `;
      } else {
        fileInfoEl.textContent = fileName;
      }

      companyInput.value = data.company || '';
      periodInput.value = data.period || '';
      amountInput.value = data.amount || '';

      statusText.textContent = status;
      if (status === 'SUBMITTED') {
        statusTag.classList.remove('hidden');
      } else {
        statusTag.classList.add('hidden');
      }
    }

    function resetClaimForm() {
      if (!state.rawClaimData) return;
      bindClaimForm(state.rawClaimData);
      setStatus('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß', false);
    }

    async function saveClaim() {
      if (!state.runNo) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö runNo ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      const company = document.getElementById('claimCompany').value.trim();
      const period = document.getElementById('claimPeriod').value.trim();
      const amount = document.getElementById('claimAmount').value.trim();

      if (!company) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Company ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
      if (!period) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Claim Period ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }
      if (!amount) { setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Amount ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true); return; }

      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim...', false);

      try {
        const payload = {
          action: 'updateClaim',
          runNo: state.runNo,
          company,
          period,
          amount
        };

        const res = await fetch(CLAIM_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        if (!json.success) throw new Error(json.message || 'Update failed');

        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Claim ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úî', false);
        if (json.data) bindClaimForm(json.data);
      } catch (err) {
        console.error('saveClaim error', err);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || 'Unknown error'), true);
      }
    }

    /** ================= INIT ================= */

    async function init() {
      const params = getQueryParams();
      state.runNo = params.runNo || '';
      state.receiver = params.receiver || '';

      // ‡πÉ‡∏ä‡πâ page ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏ô‡πâ‡∏≤ (payment / advance / claim)
      const page = (params.page || '').toLowerCase();
      const modeParam = (params.mode || params.bot || '').toLowerCase(); // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Å‡πà‡∏≤

      let mode = 'payment';
      if (page === 'claim' || page === 'travel' || modeParam === 'claim' || modeParam === 'travel') {
        mode = 'claim';
      } else {
        mode = 'payment'; // payment / advance / default
      }

      setMode(mode);

      document.getElementById('btnSavePayment').addEventListener('click', savePayment);
      document.getElementById('btnResetPayment').addEventListener('click', resetPaymentForm);
      document.getElementById('btnSaveClaim').addEventListener('click', saveClaim);
      document.getElementById('btnResetClaim').addEventListener('click', resetClaimForm);

      if (!state.runNo) {
        setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Run No. ‡πÉ‡∏ô URL ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
        return;
      }

      try {
        if (state.mode === 'payment') {
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment...', false);
          const url = PAYMENT_API_URL +
            '?action=getPayment' +
            '&runNo=' + encodeURIComponent(state.runNo) +
            '&receiver=' + encodeURIComponent(state.receiver || '');

          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          if (!json.success || !json.data) throw new Error(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment');
          bindPaymentForm(json.data);
          setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', false);
        } else {
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim...', false);
          const url = CLAIM_API_URL +
            '?action=getClaim' +
            '&runNo=' + encodeURIComponent(state.runNo);

          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          if (!json.success || !json.data) throw new Error(json.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Claim');
          bindClaimForm(json.data);
          setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', false);
        }
      } catch (err) {
        console.error('init load error', err);
        setStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || 'Unknown error') + ' (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)', true);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
