<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <style>
    :root{
      --primary:#111827;--bg:#F3F4F6;--card:#fff;--text:#1F2937;--muted:#6B7280;
      --border:#E5E7EB;--danger:#EF4444;--success:#10B981;--orange:#EA580C;
      --accent:#F9FAFB;
    }
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:20px 16px;background:var(--bg);color:var(--text);}
    .container{max-width:480px;margin:0 auto;background:var(--card);border-radius:20px;box-shadow:0 10px 25px -5px rgba(0,0,0,.05),0 8px 10px -6px rgba(0,0,0,.01);padding:24px;box-sizing:border-box;}
    .header{text-align:center;margin-bottom:24px;}
    .icon{font-size:40px;margin-bottom:12px;}
    h1{font-size:20px;font-weight:800;margin:0 0 8px;}
    .subtitle{font-size:13px;color:var(--muted);line-height:1.5}
    .info{background:var(--accent);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:24px;}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:13px;}
    .row:last-child{margin-bottom:0}
    .label{color:var(--muted);font-weight:700}
    .value{font-weight:800;text-align:right}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;background:var(--primary);color:#fff}
    .pill.orange{background:var(--orange)}
    .field{margin-bottom:16px;}
    .field label{display:block;font-size:13px;font-weight:700;margin-bottom:6px;}
    input,textarea{
      width:100%;box-sizing:border-box;padding:12px 14px;border-radius:12px;border:1.5px solid var(--border);
      font-size:15px;color:var(--text);background:#FAFAFA;transition:.2s;
    }
    textarea{min-height:90px;resize:vertical}
    input:focus,textarea:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 4px rgba(17,24,39,.1)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:6px;align-items:center}
    .buttons{margin-top:26px;display:flex;gap:12px}
    .btn{flex:1;padding:14px 16px;border-radius:14px;border:none;font-size:15px;font-weight:800;cursor:pointer;transition:transform .1s,opacity .2s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:0 4px 6px -1px rgba(17,24,39,.2)}
    .btn-secondary{background:#E5E7EB;color:#4B5563}
    .msg{margin-top:14px;font-size:13px;font-weight:700;text-align:center;padding:10px;border-radius:10px;display:none}
    .msg.show{display:block}
    .msg.success{background:#D1FAE5;color:#065F46}
    .msg.error{background:#FEE2E2;color:#991B1B}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="icon">‚úèÔ∏è</div>
      <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>
      <div class="subtitle" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
    </div>

    <div id="form" style="display:none;">
      <div class="info">
        <div class="row">
          <span class="label">Mode</span>
          <span class="value"><span id="modePill" class="pill">-</span></span>
        </div>
        <div class="row">
          <span class="label">Run No.</span>
          <span class="value" id="runNoText">-</span>
        </div>
        <div class="row">
          <span class="label">Company / Sheet</span>
          <span class="value" id="receiverText">-</span>
        </div>
      </div>

      <!-- NORMAL -->
      <div id="normalBox">
        <div class="field">
          <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer Name)</label>
          <input id="senderName" type="text" placeholder="ex. ADecor, SCG Home" />
        </div>
        <div class="field">
          <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (Date)</label>
          <input id="transactionDate" type="text" placeholder="ex. 24/2/2026" />
          <div class="hint">üí° ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</div>
        </div>
        <div class="field">
          <label>üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Amount)</label>
          <input id="amount" type="number" placeholder="ex. 5999" step="any" />
          <div class="hint">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ( , )</div>
        </div>
      </div>

      <!-- ADVANCE -->
      <div id="advanceBox" style="display:none;">
        <div class="field">
          <label>üìù Note (Advance)</label>
          <textarea id="note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
          <div class="hint">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô/‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á</div>
        </div>
      </div>

      <div class="buttons">
        <button class="btn btn-secondary" type="button" id="btnCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" type="button" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2009213238-f1ncr2hm';

    function qp() {
      const out = {};
      const s = window.location.search.substring(1);
      if (!s) return out;
      s.split("&").forEach(p => {
        if (!p) return;
        const i = p.indexOf("=");
        const k = decodeURIComponent(i >= 0 ? p.slice(0, i) : p);
        const v = decodeURIComponent(i >= 0 ? p.slice(i+1) : "");
        out[k] = v;
      });
      return out;
    }

    function show(text, type) {
      const el = document.getElementById('msg');
      if (!text) { el.className = 'msg'; el.textContent = ''; return; }
      el.textContent = text;
      el.className = 'msg show ' + (type || '');
    }

    function buildPairs(pairs) {
      return pairs.map(([k, v]) => k + '=' + encodeURIComponent(v ?? '')).join('|');
    }

    function setMode(mode) {
      const pill = document.getElementById('modePill');
      if (mode === 'ADVANCE') {
        pill.textContent = 'ADVANCE';
        pill.className = 'pill orange';
        document.getElementById('normalBox').style.display = 'none';
        document.getElementById('advanceBox').style.display = 'block';
      } else {
        pill.textContent = 'PAYMENT';
        pill.className = 'pill';
        document.getElementById('normalBox').style.display = 'block';
        document.getElementById('advanceBox').style.display = 'none';
      }
    }

    async function main() {
      const subtitle = document.getElementById('subtitle');

      try {
        await liff.init({ liffId: LIFF_ID });
      } catch (err) {
        console.error(err);
        subtitle.textContent = '‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || err);
        return;
      }

      const p = qp();
      const page = (p.page || '').toLowerCase();
      const runNo = (p.runNo || '').trim();
      let receiver = (p.receiver || '').trim();

      // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô advance ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á receiver ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ default
      if (!receiver && page === 'advance') receiver = 'ADVANCE';

      if (!runNo || !receiver) {
        subtitle.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Run No ‡∏´‡∏£‡∏∑‡∏≠ Company ‡πÉ‡∏ô URL';
        return;
      }

      const mode = (page === 'advance' || receiver.toUpperCase() === 'ADVANCE') ? 'ADVANCE' : 'NORMAL';

      // bind info
      subtitle.textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      document.getElementById('runNoText').textContent = runNo;
      document.getElementById('receiverText').textContent = receiver;
      setMode(mode);

      // prefill from URL (optional)
      if (mode === 'ADVANCE') {
        if (p.note) document.getElementById('note').value = p.note;
      } else {
        if (p.senderName) document.getElementById('senderName').value = p.senderName;
        if (p.transactionDate) document.getElementById('transactionDate').value = p.transactionDate;
        if (p.amount) document.getElementById('amount').value = p.amount;
      }

      document.getElementById('form').style.display = 'block';

      document.getElementById('btnCancel').addEventListener('click', () => {
        try {
          if (liff.isInClient()) liff.closeWindow();
          else show('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß', 'error');
        } catch (e) {}
      });

      document.getElementById('btnSave').addEventListener('click', async () => {
        show('', '');

        if (!liff.isInClient()) {
          show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE app ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
          return;
        }

        const btn = document.getElementById('btnSave');
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á...';
        btn.disabled = true;

        try {
          if (mode === 'ADVANCE') {
            const note = document.getElementById('note').value.trim();
            if (!note) { show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Note ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advance', 'error'); return; }

            const cmd = 'ADV_EDIT|' + buildPairs([
              ['runNo', runNo],
              ['receiver', receiver],
              ['note', note]
            ]);

            await liff.sendMessages([{ type: 'text', text: cmd }]);
            show('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ', 'success');
          } else {
            const senderName = document.getElementById('senderName').value.trim();
            const transactionDate = document.getElementById('transactionDate').value.trim();
            const amount = document.getElementById('amount').value.trim();

            if (!senderName) { show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error'); return; }
            if (!transactionDate) { show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô', 'error'); return; }
            if (!amount) { show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error'); return; }

            const cmd = 'PAY_EDIT|' + buildPairs([
              ['runNo', runNo],
              ['receiver', receiver],
              ['senderName', senderName],
              ['transactionDate', transactionDate],
              ['amount', amount]
            ]);

            await liff.sendMessages([{ type: 'text', text: cmd }]);
            show('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ', 'success');
          }

          setTimeout(() => { try { liff.closeWindow(); } catch (e) {} }, 800);

        } catch (e) {
          console.error(e);
          show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        } finally {
          btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          btn.disabled = false;
        }
      });
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>
