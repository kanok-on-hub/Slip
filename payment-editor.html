<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <style>
    :root{--primary:#111827;--bg:#F3F4F6;--card:#fff;--text:#1F2937;--muted:#6B7280;--border:#E5E7EB;--accent:#F9FAFB;--success:#10B981}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:20px 16px;background:var(--bg);color:var(--text)}
    .container{max-width:480px;margin:0 auto;background:var(--card);border-radius:20px;box-shadow:0 10px 25px -5px rgba(0,0,0,.05),0 8px 10px -6px rgba(0,0,0,.01);padding:24px;box-sizing:border-box}
    .header{text-align:center;margin-bottom:18px}
    .icon{font-size:40px;margin-bottom:10px}
    h1{font-size:20px;font-weight:800;margin:0 0 6px}
    .subtitle{font-size:13px;color:var(--muted);line-height:1.5}
    .info{background:var(--accent);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0 18px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:13px}
    .row:last-child{margin-bottom:0}
    .label{color:var(--muted);font-weight:800}
    .value{font-weight:900;text-align:right}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;color:#fff;background:#111827}
    .pill.orange{background:#EA580C}
    .field{margin-bottom:16px}
    .field label{display:block;font-size:13px;font-weight:900;margin-bottom:6px}
    .field input,.field textarea{width:100%;box-sizing:border-box;padding:12px 14px;border-radius:12px;border:1.5px solid var(--border);font-size:15px;color:var(--text);background:#FAFAFA}
    .field textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:6px;align-items:center}
    .filebox{background:#F9FAFB;border:1px dashed #D1D5DB;border-radius:12px;padding:12px;display:flex;gap:8px;align-items:center}
    .filebox input{border:none;background:transparent;padding:0;font-size:13px;color:#9CA3AF;width:100%}
    .buttons{display:flex;gap:12px;margin-top:22px}
    .btn{flex:1;padding:14px 16px;border-radius:14px;border:none;font-size:15px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#E5E7EB;color:#4B5563}
    .msg{margin-top:14px;font-size:13px;font-weight:900;text-align:center;padding:10px;border-radius:10px;display:none}
    .msg.show{display:block}
    .msg.success{background:#D1FAE5;color:#065F46}
    .msg.error{background:#FEE2E2;color:#991B1B}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="icon">‚úèÔ∏è</div>
      <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>
      <div class="subtitle" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</div>
    </div>

    <div id="form" style="display:none;">
      <div class="info">
        <div class="row">
          <span class="label">Mode</span>
          <span class="value"><span id="modeBadge" class="pill">-</span></span>
        </div>
        <div class="row">
          <span class="label">Run No.</span>
          <span class="value" id="runNoText">-</span>
        </div>
        <div class="row">
          <span class="label">Receiver Name</span>
          <span class="value" id="receiverText">-</span>
        </div>
      </div>

      <div id="normalFields">
        <div class="field">
          <label>üë§ Customer Name</label>
          <input id="senderName" type="text" placeholder="ex. ADecor, SCG Home">
          <div class="hint">üí° ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô SPX</div>
        </div>
        <div class="field">
          <label>üìÖ Transaction Date</label>
          <input id="transactionDate" type="text" placeholder="ex. 24/2/2026">
          <div class="hint">üí° ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (‡∏Ñ.‡∏®.)</div>
        </div>
        <div class="field">
          <label>üí∞ Amount</label>
          <input id="amount" type="number" step="any" placeholder="ex. 5999">
          <div class="hint">üí° ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà (,)</div>
        </div>
      </div>

      <div id="otherFields" style="display:none;">
        <div class="field">
          <label>üìù Note (Other)</label>
          <textarea id="note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
          <div class="hint">üí° ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢</div>
        </div>
      </div>

      <div class="field">
        <label>üîó Slip URL</label>
        <div class="filebox"><span>üìÑ</span><input id="fileUrl" type="text" readonly value="-"></div>
      </div>

      <div class="buttons">
        <button class="btn btn-secondary" id="btnCancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" id="btnSave" type="button">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>

      <div id="message" class="msg"></div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2009213238-f1ncr2hm';
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxK_PK7kslYkCpjpnBj0XX2smTvGSi3Oce-5-Ni3B_bsDcYphu-gh-krXKs07okXz2o/exec';

    function qs() {
      const params = {};
      const raw = window.location.search.substring(1).split("&");
      raw.forEach(p => {
        if (!p) return;
        const [k, v] = p.split("=");
        if (k) params[decodeURIComponent(k)] = decodeURIComponent(v || "");
      });
      return params;
    }

    function showMsg(text, type) {
      const el = document.getElementById('message');
      if (!text) { el.className = 'msg'; el.textContent = ''; return; }
      el.textContent = text;
      el.className = 'msg show ' + (type || '');
    }

    function safeValue(v) {
      return String(v ?? '').replaceAll('|','ÔΩú').replaceAll('=','Ôºù').trim();
    }
    function buildPairs(pairs) {
      return pairs.map(([k,v]) => `${k}=${safeValue(v)}`).join('|');
    }

    function cleanDateText(v){
      if(!v) return '';
      const s = String(v);
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(m) return `${Number(m[3])}/${Number(m[2])}/${m[1]}`;
      return s.replace(/T.*$/,'').trim();
    }

    function setModeUI(mode) {
      const badge = document.getElementById('modeBadge');
      if (mode === 'OTHER') {
        badge.textContent = 'OTHER';
        badge.className = 'pill orange';
        document.getElementById('normalFields').style.display = 'none';
        document.getElementById('otherFields').style.display = 'block';
      } else {
        badge.textContent = 'PAYMENT';
        badge.className = 'pill';
        document.getElementById('normalFields').style.display = 'block';
        document.getElementById('otherFields').style.display = 'none';
      }
    }

    async function prefill(runNo, receiver) {
      const url = `${BACKEND_URL}?action=getPayment&runNo=${encodeURIComponent(runNo)}&receiver=${encodeURIComponent(receiver)}`;
      const res = await fetch(url, { method: 'GET' });
      const json = await res.json();
      if (!json.success) throw new Error(json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      return json.data || {};
    }

    async function main() {
      const subtitle = document.getElementById('subtitle');

      try { await liff.init({ liffId: LIFF_ID }); }
      catch (err) {
        console.error(err);
        subtitle.textContent = '‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || err);
        return;
      }

      const p = qs();
      const page = (p.page || '').toLowerCase(); // payment | other
      const runNo = (p.runNo || '').trim();
      let receiver = (p.receiver || '').trim();
      if (!receiver && page === 'other') receiver = 'OTHER';

      if (!runNo || !receiver) {
        subtitle.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Run No ‡∏´‡∏£‡∏∑‡∏≠ Receiver ‡πÉ‡∏ô URL';
        return;
      }

      document.getElementById('runNoText').textContent = runNo;
      document.getElementById('receiverText').textContent = receiver;

      let data = {};
      try {
        data = await prefill(runNo, receiver);
        subtitle.textContent = '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚úÖ';
      } catch (e) {
        console.error(e);
        subtitle.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        showMsg(e.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }

      const isOther =
        page === 'other' ||
        String(receiver).toUpperCase() === 'OTHER' ||
        String(data.mode || '').toUpperCase() === 'OTHER';

      document.body.dataset.mode = isOther ? 'OTHER' : 'PAYMENT';
      setModeUI(isOther ? 'OTHER' : 'PAYMENT');

      document.getElementById('fileUrl').value = data.fileUrl || '-';

      if (isOther) {
        document.getElementById('note').value = data.note || data.noteText || '';
      } else {
        document.getElementById('senderName').value = data.senderName || '';
        document.getElementById('transactionDate').value = cleanDateText(data.transactionDateText || data.transactionDate || '');
        document.getElementById('amount').value = (data.amountText || data.amount || '');
      }

      document.getElementById('form').style.display = 'block';

      document.getElementById('btnCancel').addEventListener('click', () => {
        try { if (liff.isInClient()) liff.closeWindow(); } catch(e){}
      });

      document.getElementById('btnSave').addEventListener('click', async () => {
        showMsg('', '');

        if (!liff.isInClient()) { showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE app ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error'); return; }

        const mode = (document.body.dataset.mode || 'PAYMENT').toUpperCase();
        const btn = document.getElementById('btnSave');

        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...'; btn.disabled = true;

        try {
          if (mode === 'OTHER') {
            const note = document.getElementById('note').value.trim();
            if (!note) { showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Note ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Other', 'error'); return; }

            const cmd = 'OTHER_EDIT|' + buildPairs([
              ['runNo', runNo],
              ['receiver', receiver],
              ['note', note]
            ]);
            await liff.sendMessages([{ type: 'text', text: cmd }]);

            // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
            showMsg('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‚úÖ', 'success');

          } else {
            const senderName = document.getElementById('senderName').value.trim();
            const transactionDate = document.getElementById('transactionDate').value.trim();
            const amount = document.getElementById('amount').value.trim();

            if (!senderName) { showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Customer Name', 'error'); return; }
            if (!transactionDate) { showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Transaction Date', 'error'); return; }
            if (!amount) { showMsg('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Amount', 'error'); return; }

            const cmd = 'PAY_EDIT|' + buildPairs([
              ['runNo', runNo],
              ['receiver', receiver],
              ['senderName', senderName],
              ['transactionDate', transactionDate],
              ['amount', amount]
            ]);
            await liff.sendMessages([{ type: 'text', text: cmd }]);

            // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
            showMsg('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‚úÖ', 'success');
          }

          setTimeout(() => { try { liff.closeWindow(); } catch(e){} }, 900);

        } catch (e) {
          console.error('sendMessages error:', e);
          showMsg('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        } finally {
          btn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; btn.disabled = false;
        }
      });
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>






